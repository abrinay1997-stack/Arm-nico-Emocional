<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Maestro Emocional AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      /* Add a simple fade-in animation for the results */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0",
    "midi-writer-js": "https://esm.sh/midi-writer-js@2.1.4",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
import React, { useState, useCallback, useEffect, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Type } from "@google/genai";
import * as MidiWriter from 'midi-writer-js';

// --- From constants.ts ---
const EMOTIONS_LIST = [
  "Felicidad", "Alegría desbordada", "Gozo", "Júbilo", "Regocijo", "Euforia", "Éxtasis", "Exaltación", "Plenitud", "Paz", "Serenidad", "Sosiego", "Quietud", "Calma", "Armonía", "Bienestar", "Satisfacción", "Claridad",
  "Amor", "Afecto", "Cariño", "Ternura", "Dulzura", "Compasión", "Empatía", "Conexión", "Intimidad", "Sensualidad", "Deseo", "Pasión ardiente", "Lujuria", "Tristeza", "Pena", "Melancolía", "Congoja", "Aflicción", "Nostalgia", "Desconsuelo", "Abatimiento", "Desesperación",
  "Molestia", "Irritación", "Enojo", "Enojo contenido", "Ira", "Rabia", "Furia", "Frustración", "Hastío", "Rencor", "Resentimiento", "Explosión emocional", "Inquietud", "Preocupación", "Nerviosismo", "Ansiedad", "Agobio", "Zozobra", "Temor", "Miedo", "Pavor", "Terror", "Pánico",
  "Esperanza", "Optimismo", "Inspiración", "Motivación", "Entusiasmo", "Determinación", "Confianza", "Orgullo", "Triunfo", "Soledad", "Aislamiento", "Desamparo", "Abandono", "Vacío", "Desconexión", "Alienación", "Desapego", "Interés", "Curiosidad", "Intriga", "Admiración", "Asombro", "Sorpresa", "Estupor", "Perplejidad", "Duda", "Confusión", "Confusión interna", "Anticipación", "Expectación", "Suspenso", "Misterio", "Calma antes de la tormenta", "Tensión", "Bloqueo", "Fluir", "Caos", "Desorden", "Orden", "Equilibrio",
  "Alivio", "Liberación", "Impotencia", "Resignación", "Apatía", "Indiferencia", "Aceptación", "Dolor físico", "Placer (físico)", "Excitación", "Vértigo", "Escalofrío", "Cansancio", "Fatiga", "Agotamiento"
];
const EMOTION_MODIFIERS = [
  "cinemático", "Sinfónico", "Épico", "Gótico", "Futurista", "R&B", "Reggaeton", "Reggae", "Dancehall", "Pop", "Bailable", "Agresivo", "Atmosférico", "Retro", "Acústico", "Electrónico", "Funk", "Jazz", "Minimalista", "Complejo"
];
const MUSIC_KEYS = [
    "C", "C# / Db", "D", "D# / Eb", "E", "F", "F# / Gb", "G", "G# / Ab", "A", "A# / Bb", "B"
];
const MUSIC_SCALES = [
    "Mayor (Jónico)", "Menor (Eólico)", "Menor Armónica", "Menor Melódica", "Dórico", "Frigio", "Lidio", "Mixolidio", "Locrio", "Pentatónica Mayor", "Pentatónica Menor", "Blues"
];
const CHORD_DURATIONS = {
  '1': 'Redonda (Whole)',
  '2': 'Blanca (Half)',
  '4': 'Negra (Quarter)',
  '8': 'Corchea (Eighth)',
  '16': 'Semicorchea (Sixteenth)',
};
const VOICE_LEADING_MODES = {
  'smooth': 'Movimiento Mínimo (Suave)',
  'contrary': 'Movimiento Contrario',
  'common_tones': 'Mantener Notas Comunes',
};
const STEPS = [
    "Emociones",
    "Parámetros",
    "Resultado"
];

// --- From utils/midiGenerator.ts ---
const NOTE_TO_MIDI_VAL = {
  'C': 0, 'B#': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'Fb': 4,
  'F': 5, 'E#': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11, 'Cb': 11,
};
const getVoicing = (notes, baseOctave = 3) => {
    if (!notes || notes.length === 0) return [];
    const midiToNoteMap = new Map();
    const notesWithMidi = notes
      .map(name => name.trim())
      .map(name => ({ name, midi: NOTE_TO_MIDI_VAL[name.replace(/[0-9]/g, '')] }))
      .filter(item => item.midi !== undefined);
    if (notesWithMidi.length === 0) return [];
    notesWithMidi.forEach(n => midiToNoteMap.set(n.midi, n.name));
    const sortedMidiValues = [...new Set(notesWithMidi.map(n => n.midi))].sort((a, b) => a - b);
    const rootNoteName = notes[0].trim().replace(/[0-9]/g, '');
    const rootMidiValue = NOTE_TO_MIDI_VAL[rootNoteName];
    if (rootMidiValue === undefined) return [];
    const rootIndex = sortedMidiValues.indexOf(rootMidiValue);
    if (rootIndex === -1) return [];
    const arrangedMidiValues = [...sortedMidiValues.slice(rootIndex), ...sortedMidiValues.slice(0, rootIndex)];
    let currentOctave = baseOctave;
    let lastMidiValue = -1;
    const voicedNotes = [];
    arrangedMidiValues.forEach(midiValue => {
        if (midiValue < lastMidiValue) {
            currentOctave++;
        }
        const noteName = midiToNoteMap.get(midiValue);
        voicedNotes.push(`${noteName}${currentOctave}`);
        lastMidiValue = midiValue;
    });
    return voicedNotes;
};
const addLineToTrack = (track, line) => {
    const TICKS_PER_QUARTER = 128;
    const timeStringToTicks = (time) => {
        const parts = time.split(':').map(Number);
        const [measure = 0, quarter = 0, sixteenth = 0] = parts;
        const ticksPerMeasure = 4 * TICKS_PER_QUARTER;
        const ticksPerSixteenth = TICKS_PER_QUARTER / 4;
        return (measure * ticksPerMeasure) + (quarter * TICKS_PER_QUARTER) + (sixteenth * ticksPerSixteenth);
    };
    const convertToneDurationToMidi = (toneDuration) => {
        if (toneDuration.endsWith('m')) {
            return toneDuration.slice(0, -1);
        }
        let midiDuration = toneDuration.replace('n', '');
        if (midiDuration.endsWith('.')) {
            midiDuration = 'd' + midiDuration.slice(0, -1);
        }
        return midiDuration;
    };
    line.forEach(item => {
        if (item.note && item.note.toLowerCase() !== 'rest') {
             track.addEvent(new MidiWriter.NoteEvent({
                pitch: [item.note],
                startTick: timeStringToTicks(item.time),
                duration: convertToneDurationToMidi(item.duration)
            }));
        }
    });
};
const generateFullMidiDataUri = (progression, bpm, chordDuration, generatedLines) => {
  try {
    const tracks = [];
    const chordTrack = new MidiWriter.Track();
    chordTrack.setTempo(bpm);
    chordTrack.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 1 }));
    let tick = 0;
    const durationTicks = (4 / parseInt(chordDuration, 10)) * 128;
    progression.forEach(item => {
      const notes = item.notes.split(' - ');
      const voicedNotes = getVoicing(notes);
      if (voicedNotes.length > 0) {
          chordTrack.addEvent(new MidiWriter.NoteEvent({ pitch: voicedNotes, startTick: tick, duration: `T${durationTicks}`, velocity: 100 }));
      }
      tick += durationTicks;
    });
    tracks.push(chordTrack);
    if (generatedLines.bass && generatedLines.bass.length > 0) {
        const bassTrack = new MidiWriter.Track();
        bassTrack.setTempo(bpm);
        bassTrack.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 33 }));
        addLineToTrack(bassTrack, generatedLines.bass);
        tracks.push(bassTrack);
    }
    if (generatedLines.melody && generatedLines.melody.length > 0) {
        const melodyTrack = new MidiWriter.Track();
        melodyTrack.setTempo(bpm);
        melodyTrack.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 74 }));
        addLineToTrack(melodyTrack, generatedLines.melody);
        tracks.push(melodyTrack);
    }
    if (generatedLines.ostinato && generatedLines.ostinato.length > 0) {
        const ostinatoTrack = new MidiWriter.Track();
        ostinatoTrack.setTempo(bpm);
        ostinatoTrack.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 82 }));
        addLineToTrack(ostinatoTrack, generatedLines.ostinato);
        tracks.push(ostinatoTrack);
    }
    const write = new MidiWriter.Writer(tracks);
    const dataUri = write.dataUri();
    if (!dataUri) throw new Error('La biblioteca MIDI generó un archivo vacío.');
    return dataUri;
  } catch (error) {
    console.error("Error generating full MIDI data URI:", error);
    throw new Error(`Ocurrió un error al generar el archivo MIDI completo: ${error instanceof Error ? error.message : String(error)}`);
  }
};
const generateSingleLineMidiDataUri = (line, bpm, instrument) => {
    try {
        const track = new MidiWriter.Track();
        track.setTempo(bpm);
        track.addEvent(new MidiWriter.ProgramChangeEvent({ instrument }));
        addLineToTrack(track, line);
        const write = new MidiWriter.Writer([track]);
        const dataUri = write.dataUri();
        if (!dataUri) throw new Error('La biblioteca MIDI generó un archivo vacío.');
        return dataUri;
    } catch (error) {
        console.error("Error generating single line MIDI data URI:", error);
        throw new Error(`Ocurrió un error al generar el archivo MIDI: ${error instanceof Error ? error.message : String(error)}`);
    }
};

// --- From services/geminiService.ts ---
// WARNING: Storing your API key directly in the code is not secure for public applications.
// This is done for simplicity in this private GitHub Pages example.
// For a production app, use a backend server to protect your key.
const apiKey = "AIzaSyDmsXw8N2CsRYy3Vqh1JAvXY1dM104uEO8";
const ai = new GoogleGenAI({ apiKey });

const chordProgressionSchema = {
  type: Type.OBJECT,
  properties: {
    progression: {
      type: Type.ARRAY,
      description: "La progresión de acordes generada.",
      items: {
        type: Type.OBJECT,
        properties: {
          chord: { type: Type.STRING, description: "El nombre del acorde, ej. Gmaj7." },
          notes: { type: Type.STRING, description: "Las notas que componen el acorde, ej. G - B - D - F#." },
          degree: { type: Type.STRING, description: "El grado del acorde en la tonalidad, ej. I, V, iv." }
        },
        required: ["chord", "notes", "degree"]
      }
    },
    analysis: {
      type: Type.STRING,
      description: "Un análisis conciso y preciso de por qué se eligió la progresión, conectando cada acorde o transición con la mezcla emocional solicitada. Debe ser breve y directo."
    },
  },
  required: ["progression", "analysis"],
};
const musicalLineSchema = {
    type: Type.OBJECT,
    properties: {
        line: {
            type: Type.ARRAY,
            description: "La línea musical generada.",
            items: {
                type: Type.OBJECT,
                properties: {
                    note: { type: Type.STRING, description: "La nota con su octava, ej. C4, F#3. Usar 'rest' para silencios." },
                    duration: { type: Type.STRING, description: "La duración en notación de Tone.js, ej. '4n', '8n', '1m'." },
                    time: { type: Type.STRING, description: "El tiempo de inicio en formato de Tone.js 'compas:division:subdivision', ej. '0:0:0', '0:2:0'." }
                },
                required: ["note", "duration", "time"]
            }
        }
    },
    required: ["line"],
};

const getVoiceLeadingInstructions = (mode) => {
    switch (mode) {
        case 'smooth':
            return 'Prioriza que las notas se muevan lo menos posible entre acordes. Busca las inversiones de acordes que permitan transiciones suaves y fluidas, manteniendo las notas comunes en la misma octava si es posible.';
        case 'contrary':
            return 'Busca oportunidades para que la línea del bajo se mueva en dirección opuesta a la voz superior (la nota más alta del acorde). Esto crea una sensación de expansión o contracción armónica.';
        case 'common_tones':
            return 'Identifica las notas comunes entre acordes consecutivos y haz un esfuerzo por mantenerlas en la misma voz (misma octava). Esto crea un ancla melódica y una sensación de coherencia a lo largo de la progresión.';
        default:
            return 'Usa tu mejor juicio musical para crear conducciones de voces efectivas.';
    }
};

const generateChordProgression = async (emotions, keyAndScale, bpm, numChords, styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference, voiceLeading, regenerationData = null) => {
  let prompt;
  
  const coreContext = `
    **Contexto Creativo Principal:**
    - **Núcleo Narrativo (Contexto Emocional):** ${emotionalContext || "No especificado. Concéntrate en las emociones."}
    - **Emociones (en orden de prioridad):** ${emotions.join(", ")}
    
    **Directrices de Estilo y Sonido:**
    - **Modificadores de Estilo Generales:** ${styleModifiers.length > 0 ? styleModifiers.join(", ") : "Ninguno"}
    - **Referencia Armónica (Acordes/Voicings):** ${harmonicReference || "Ninguna"}
    - **Referencia Rítmica (Groove/Sensación):** ${rhythmicReference || "Ninguna"}
    - **Referencia Sonora (Instrumentación/Textura):** ${sonicReference || "Ninguna"}

    **Parámetros Técnicos:**
    - **Tonalidad y Escala:** ${keyAndScale}
    - **Tempo (BPM):** ${bpm}
    - **Reglas de Conducción de Voces (Voice Leading):** ${getVoiceLeadingInstructions(voiceLeading)}
  `;

  if (regenerationData) {
      const { currentProgression, lockedIndices, originalAnalysis } = regenerationData;
      const progressionString = currentProgression.map((c, i) => `${i + 1}. ${c.chord} (${c.degree}) - ${lockedIndices.includes(i) ? 'BLOQUEADO (NO CAMBIAR)' : 'REGENERAR'}`).join('\n');
      prompt = `
        Eres un asistente de composición. Te proporciono una progresión de acordes y te pido que regeneres solo las partes no bloqueadas, manteniendo el contexto original.

        **Contexto Original (DEBE MANTENERSE):**
        ${coreContext}
        - **Análisis Original (para referencia):** ${originalAnalysis}

        **Progresión Actual:**
        ${progressionString}
        
        **Tu Tarea Detallada:**
        1.  **Mantén los Acordes Bloqueados:** Los acordes marcados como "BLOQUEADO" son perfectos. NO los alteres de ninguna manera. Cópialos exactamente en tu respuesta.
        2.  **Regenera los Acordes No Bloqueados:** Crea nuevos acordes únicamente para las posiciones marcadas como "REGENERAR".
        3.  **Asegura la Coherencia:** Los nuevos acordes deben conectarse musical, rítmica y emocionalmente con los acordes bloqueados. La progresión completa debe sentirse como una sola pieza coherente y seguir las reglas de conducción de voces.
        4.  **Actualiza el Análisis:** Modifica el análisis original para reflejar los cambios. Explica por qué los nuevos acordes funcionan y cómo interactúan con los acordes bloqueados para cumplir el objetivo emocional.
        5.  **Respuesta Exclusivamente en JSON:** Responde únicamente con el objeto JSON COMPLETO de la nueva progresión (incluyendo los acordes bloqueados sin cambios) y el nuevo análisis, usando el esquema proporcionado. No incluyas nada fuera del formato JSON.
      `;
  } else {
      prompt = `
        Eres "Maestro Emocional AI", una IA experta en composición y teoría musical con un profundo conocimiento de la psicología de la música. Tu propósito es generar una progresión de acordes que capture la esencia de una narrativa emocional y un estilo musical detallado.

        ${coreContext}
        - **Número de Acordes a Generar:** ${numChords}

        **Tu Tarea Detallada:**
        1.  **Síntesis Creativa:** Tu tarea más importante es SINTETIZAR todas las directrices de arriba en una idea musical coherente. El **Núcleo Narrativo** es tu guía principal. Las emociones deben ser expresadas a través del filtro de las referencias específicas. Por ejemplo, si el contexto es "nostalgia" y la referencia armónica es "Bill Evans", debes usar acordes de jazz con tensiones sutiles y melancólicas.
        2.  **Generación de Acordes:** Genera una progresión de exactamente ${numChords} acordes que encarne esta síntesis. No te limites a acordes diatónicos; usa acordes prestados, dominantes secundarios o modulaciones si sirven a la narrativa y las referencias. Presta especial atención a la **Conducción de Voces**.
        3.  **Formato de Salida:** Para cada acorde, especifica su nombre (ej. Gmaj7), las notas que lo componen (ej. G - B - D - F#), y su grado en la tonalidad (ej. I, V, iv).
        4.  **Análisis Profundo:** Proporciona un análisis conciso pero experto, explicando el "por qué" de tus elecciones. Conecta tus decisiones armónicas directamente al **Núcleo Narrativo**, las **Emociones**, las **Referencias** y la **Conducción de Voces**. Explica cómo un acorde o una transición refuerza la historia.
        5.  **Respuesta Exclusivamente en JSON:** Responde únicamente con un objeto JSON que se ajuste al esquema proporcionado. No incluyas absolutamente nada fuera del formato JSON.
      `;
  }

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-pro",
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: chordProgressionSchema,
        thinkingConfig: { thinkingBudget: 32768 },
      },
    });
    const jsonText = response.text.trim();
    const result = JSON.parse(jsonText);
    if (result && Array.isArray(result.progression) && typeof result.analysis === 'string') {
        return result;
    } else {
        throw new Error("Invalid JSON structure received from API.");
    }
  } catch (error) {
    console.error("Error calling Gemini API:", error);
    throw new Error("No se pudo generar la progresión. Por favor, inténtelo de nuevo.");
  }
};
const generateMusicalLine = async (progression, emotions, keyAndScale, bpm, lineType, styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference) => {
    let typeInstructions;
    switch (lineType) {
        case 'bass':
            typeInstructions = `
              **Tu Tarea:** Crear una línea de bajo **moderna, profesional y minimalista**. El *groove*, el *espacio* y la conexión con la **Referencia Rítmica** son cruciales. Debe ser el fundamento que se *siente*.`;
            break;
        case 'melody':
            typeInstructions = `
              **Tu Tarea:** Crear una **MELODÍA POP MODERNA (un "Topline")** que sea el gancho principal y el foco del **Núcleo Narrativo**. Debe ser memorable y rítmicamente atractiva, inspirada fuertemente en la **Referencia Armónica y Sonora**.`;
            break;
        case 'ostinato':
            typeInstructions = `
              **Tu Tarea:** Crear un **OSTINATO MODERNO** que actúe como una textura hipnótica. Debe ser repetitivo, complementar la armonía y añadir movimiento, basándose en la **Referencia Sonora** para su timbre y carácter (ej. arpegio de sinte, piano filtrado).`;
            break;
    }
    const progressionString = progression.map(p => `${p.degree} (${p.chord})`).join(' | ');
    const prompt = `
        Eres un productor musical de élite. Tu tarea es componer una línea musical profesional (${lineType}) dentro de un contexto creativo ya definido.

        **Contexto Creativo Principal:**
        - **Progresión de Acordes:** ${progressionString}
        - **Núcleo Narrativo (Contexto Emocional):** ${emotionalContext || "No especificado. Concéntrate en las emociones."}
        - **Emociones (en orden de prioridad):** ${emotions.join(", ")}

        **Directrices de Estilo y Sonido:**
        - **Modificadores de Estilo Generales:** ${styleModifiers.length > 0 ? styleModifiers.join(", ") : "Ninguno"}
        - **Referencia Armónica (Acordes/Voicings):** ${harmonicReference || "Ninguna"}
        - **Referencia Rítmica (Groove/Sensación):** ${rhythmicReference || "Ninguna"}
        - **Referencia Sonora (Instrumentación/Textura):** ${sonicReference || "Ninguna"}

        **Parámetros Técnicos:**
        - **Tonalidad y Escala:** ${keyAndScale}
        - **Tempo (BPM):** ${bpm}

        **Instrucciones Específicas para la Línea de ${lineType.toUpperCase()}:**
        1.  **Asimilación Profunda:** Interioriza el **Núcleo Narrativo** y las **Referencias**. Tu línea DEBE servir a estos elementos. Si la referencia rítmica es "J Dilla", el bajo debe tener un feel "laid-back". Si la referencia sonora es "sintes de los 80", el ostinato debe sonar a eso.
        2.  **Tarea Específica:** ${typeInstructions}
        3.  **Duración y Estructura:** La línea debe durar exactamente ${progression.length} compases (asume 4/4). Debe ser musical y coherente.
        4.  **Formato de Salida:** Genera la línea como una secuencia de eventos de nota en JSON. Especifica la nota (con octava, ej. C3, F#4), su duración en notación de Tone.js ('4n', '8n', '1m', etc.), y su tiempo de inicio absoluto en formato 'compas:division:subdivision'.
        5.  **Respuesta Exclusivamente en JSON:** Responde únicamente con un objeto JSON que se ajuste al esquema proporcionado. No incluyas nada fuera del formato JSON.
    `;
    try {
        const response = await ai.models.generateContent({
            model: "gemini-2.5-pro",
            contents: prompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: musicalLineSchema
            },
        });
        const jsonText = response.text.trim();
        const result = JSON.parse(jsonText);
        if (result && Array.isArray(result.line)) {
            return result.line;
        } else {
            throw new Error(`Invalid JSON structure for ${lineType} line.`);
        }
    } catch (error) {
        console.error(`Error calling Gemini API for ${lineType} line:`, error);
        throw new Error(`No se pudo generar la línea de ${lineType}. Inténtalo de nuevo.`);
    }
};

// --- From components/Loader.tsx ---
const Loader = ({ isRegenerating = false }) => {
  const message = isRegenerating ? "Refinando tu progresión..." : "Maestro Emocional AI está creando tu pieza musical.";
  const title = isRegenerating ? "Regenerando..." : "Componiendo...";
  return React.createElement('div', { className: "flex flex-col items-center justify-center space-y-4" },
    React.createElement('div', { className: "w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500" }),
    React.createElement('h3', { className: "text-lg font-semibold text-white" }, title),
    React.createElement('p', { className: "text-gray-400 text-sm" }, message)
  );
};

// --- From components/Stepper.tsx ---
const Stepper = ({ steps, currentStep }) => {
  return React.createElement('nav', { 'aria-label': "Progress" },
    React.createElement('ol', { role: "list", className: "flex items-center justify-center" },
      steps.map((step, stepIdx) => React.createElement('li', { key: step, className: `relative ${stepIdx !== steps.length - 1 ? 'pr-8 sm:pr-20' : ''}` },
        stepIdx < currentStep ?
          React.createElement(React.Fragment, null,
            React.createElement('div', { className: "absolute inset-0 flex items-center", 'aria-hidden': "true" },
              React.createElement('div', { className: "h-0.5 w-full bg-indigo-600" })
            ),
            React.createElement('div', { className: "relative flex h-8 w-8 items-center justify-center rounded-full bg-indigo-600 hover:bg-indigo-900" },
              React.createElement('svg', { className: "h-5 w-5 text-white", viewBox: "0 0 20 20", fill: "currentColor", 'aria-hidden': "true" },
                React.createElement('path', { fillRule: "evenodd", d: "M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z", clipRule: "evenodd" })
              )
            )
          ) :
        stepIdx === currentStep ?
          React.createElement(React.Fragment, null,
            React.createElement('div', { className: "absolute inset-0 flex items-center", 'aria-hidden': "true" },
              React.createElement('div', { className: "h-0.5 w-full bg-gray-700" })
            ),
            React.createElement('div', { className: "relative flex h-8 w-8 items-center justify-center rounded-full border-2 border-indigo-600 bg-gray-800" },
              React.createElement('span', { className: "h-2.5 w-2.5 rounded-full bg-indigo-600", 'aria-hidden': "true" })
            )
          ) :
          React.createElement(React.Fragment, null,
            React.createElement('div', { className: "absolute inset-0 flex items-center", 'aria-hidden': "true" },
              React.createElement('div', { className: "h-0.5 w-full bg-gray-700" })
            ),
            React.createElement('div', { className: "relative flex h-8 w-8 items-center justify-center rounded-full border-2 border-gray-600 bg-gray-800" })
          ),
        React.createElement('span', { className: "absolute top-10 left-4 -translate-x-1/2 text-xs font-semibold text-gray-300 w-20 text-center" }, step)
      ))
    )
  );
};

// --- From components/EmotionSelector.tsx ---
const EmotionSelector = ({ selectedEmotions, onToggleEmotion, onReorderEmotions, onNext }) => {
  const canProceed = selectedEmotions.length > 0 && selectedEmotions.length <= 4;
  const [draggingItem, setDraggingItem] = useState(null);
  const dragOverItem = useRef(null);
  const handleDragStart = (e, index) => {
    setDraggingItem(index);
    e.dataTransfer.effectAllowed = 'move';
  };
  const handleDragEnter = (index) => {
    dragOverItem.current = index;
  };
  const handleDragEnd = () => {
    if (draggingItem !== null && dragOverItem.current !== null && draggingItem !== dragOverItem.current) {
      const listCopy = [...selectedEmotions];
      const draggingItemContent = listCopy.splice(draggingItem, 1)[0];
      listCopy.splice(dragOverItem.current, 0, draggingItemContent);
      onReorderEmotions(listCopy);
    }
    setDraggingItem(null);
    dragOverItem.current = null;
  };
  const handleDragOver = (e) => e.preventDefault();
  const selectedEmotionNames = selectedEmotions.map(e => e.name);

  return React.createElement('div', { className: "w-full flex flex-col items-center" },
    React.createElement('h2', { className: "text-2xl font-bold text-white mb-2" }, "Paso 1: Elige y Prioriza tus Emociones"),
    React.createElement('p', { className: "text-gray-400 mb-6 text-center" }, "Selecciona de 1 a 4 emociones y ordénalas arrastrando. La de arriba será la dominante."),
    React.createElement('div', { className: "w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8" },
      React.createElement('div', { className: "flex flex-col" },
        React.createElement('h3', { className: "text-lg font-semibold text-white mb-4 text-center md:text-left" }, "Emociones Seleccionadas (Prioridad)"),
        React.createElement('div', { className: "bg-gray-800/50 rounded-lg border border-gray-700 p-4 min-h-[280px]" },
          selectedEmotions.length > 0 ?
            React.createElement('ul', { className: "space-y-3" },
              selectedEmotions.map((emotion, index) =>
                React.createElement('li', {
                  key: emotion.id,
                  draggable: true,
                  onDragStart: (e) => handleDragStart(e, index),
                  onDragEnter: () => handleDragEnter(index),
                  onDragEnd: handleDragEnd,
                  onDragOver: handleDragOver,
                  className: `p-3 rounded-lg flex items-center justify-between cursor-move transition-all duration-300 ${draggingItem === index ? 'bg-indigo-800 scale-105 shadow-2xl' : 'bg-gray-700 shadow-md border border-gray-600'}`
                },
                  React.createElement('div', { className: "flex items-center" },
                    React.createElement('span', { className: "text-indigo-400 font-bold text-lg mr-3 w-6 text-center" }, index + 1),
                    React.createElement('span', { className: "text-white font-medium" }, emotion.name)
                  ),
                  React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 text-gray-400 flex-shrink-0", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                    React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M4 6h16M4 12h16m-7 6h7" })
                  )
                )
              )
            ) :
            React.createElement('div', { className: "flex items-center justify-center h-full" },
              React.createElement('p', { className: "text-gray-500" }, "Selecciona emociones de la lista...")
            )
        )
      ),
      React.createElement('div', null,
        React.createElement('h3', { className: "text-lg font-semibold text-white mb-4 text-center md:text-left" }, "Lista de Emociones"),
        React.createElement('div', { className: "w-full p-4 bg-gray-800/50 rounded-lg border border-gray-700 max-h-[280px] overflow-y-auto" },
          React.createElement('div', { className: "flex flex-wrap gap-3 justify-center" },
            EMOTIONS_LIST.map((emotion) => {
              const isSelected = selectedEmotionNames.includes(emotion);
              const isDisabled = !isSelected && selectedEmotions.length >= 4;
              return React.createElement('button', {
                key: emotion,
                onClick: () => onToggleEmotion(emotion),
                disabled: isDisabled,
                className: `px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 ${isSelected ? 'bg-indigo-600 text-white shadow-lg ring-2 ring-indigo-400' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`
              }, emotion);
            })
          )
        )
      )
    ),
    React.createElement('div', { className: "w-full max-w-4xl mt-8 flex justify-end" },
      React.createElement('button', {
        onClick: onNext,
        disabled: !canProceed,
        className: "px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors duration-200"
      }, "Siguiente")
    )
  );
};

// --- From components/ParametersForm.tsx ---
const ParametersForm = ({ 
  musicKey, musicScale, bpm, numChords, chordDuration, voiceLeading,
  styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference,
  onToggleModifier, onParamChange, onBack, onGenerate 
}) => {
  return React.createElement('div', { className: "w-full flex flex-col items-center" },
    React.createElement('h2', { className: "text-2xl font-bold text-white mb-2" }, "Paso 2: Parámetros Musicales"),
    React.createElement('p', { className: "text-gray-400 mb-6 text-center" }, "Define la tonalidad, el ritmo y el estilo de tu pieza."),
    React.createElement('div', { className: "w-full max-w-lg space-y-6" },
      React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
        React.createElement('div', null,
          React.createElement('label', { htmlFor: "key", className: "block text-sm font-medium text-gray-300 mb-2" }, "Tonalidad"),
          React.createElement('select', { id: "key", value: musicKey, onChange: (e) => onParamChange('musicKey', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" },
            MUSIC_KEYS.map((k) => React.createElement('option', { key: k, value: k }, k))
          )
        ),
        React.createElement('div', null,
          React.createElement('label', { htmlFor: "scale", className: "block text-sm font-medium text-gray-300 mb-2" }, "Escala"),
          React.createElement('select', { id: "scale", value: musicScale, onChange: (e) => onParamChange('musicScale', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" },
            MUSIC_SCALES.map((s) => React.createElement('option', { key: s, value: s }, s))
          )
        ),
        React.createElement('div', null,
          React.createElement('label', { htmlFor: "bpm", className: "block text-sm font-medium text-gray-300 mb-2" }, "Tempo (BPM)"),
          React.createElement('input', { type: "number", id: "bpm", value: bpm, onChange: (e) => onParamChange('bpm', parseInt(e.target.value, 10)), min: "40", max: "220", className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" })
        ),
        React.createElement('div', null,
          React.createElement('label', { htmlFor: "numChords", className: "block text-sm font-medium text-gray-300 mb-2" }, "Nº de Acordes"),
          React.createElement('input', { type: "number", id: "numChords", value: numChords, onChange: (e) => onParamChange('numChords', parseInt(e.target.value, 10)), min: "2", max: "16", className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" })
        ),
        React.createElement('div', { className: "md:col-span-2" },
          React.createElement('label', { htmlFor: "chordDuration", className: "block text-sm font-medium text-gray-300 mb-2" }, "Duración por Acorde"),
          React.createElement('select', { id: "chordDuration", value: chordDuration, onChange: (e) => onParamChange('chordDuration', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" },
            Object.entries(CHORD_DURATIONS).map(([value, name]) => React.createElement('option', { key: value, value: value }, name))
          )
        ),
        React.createElement('div', { className: "md:col-span-2" },
            React.createElement('label', { htmlFor: "voiceLeading", className: "block text-sm font-medium text-gray-300 mb-2" }, "Conducción de Voces (Voice Leading)"),
            React.createElement('select', { id: "voiceLeading", value: voiceLeading, onChange: (e) => onParamChange('voiceLeading', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" },
                Object.entries(VOICE_LEADING_MODES).map(([value, name]) => React.createElement('option', { key: value, value: value }, name))
            )
        )
      ),
      React.createElement('div', null,
        React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-2" }, "Modificadores de Estilo"),
        React.createElement('p', { className: "text-xs text-gray-500 mb-3" }, "Selecciona hasta 3 para refinar el resultado."),
        React.createElement('div', { className: "flex flex-wrap gap-2" },
          EMOTION_MODIFIERS.map(mod => {
            const isSelected = styleModifiers.includes(mod);
            const isDisabled = !isSelected && styleModifiers.length >= 3;
            return React.createElement('button', {
              key: mod,
              onClick: () => onToggleModifier(mod),
              disabled: isDisabled,
              className: `px-3 py-1.5 rounded-full text-sm font-medium transition-all duration-200 ${isSelected ? 'bg-indigo-600 text-white shadow-lg ring-2 ring-indigo-400' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`
            }, mod);
          })
        )
      ),
       React.createElement('div', null,
            React.createElement('label', { htmlFor: "emotionalContext", className: "block text-sm font-medium text-gray-300 mb-2" }, "Contexto Emocional (Opcional)"),
            React.createElement('textarea', { id: "emotionalContext", value: emotionalContext, onChange: (e) => onParamChange('emotionalContext', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500", placeholder: "Ej: Una despedida agridulce en una estación de tren lluviosa.", rows: 2 })
       ),
       React.createElement('div', {className: "space-y-4"},
          React.createElement('h3', {className: "text-sm font-medium text-gray-300 mb-2"}, "Referencias Específicas (Opcional)"),
          React.createElement('div', null,
              React.createElement('label', { htmlFor: "harmonicReference", className: "block text-xs font-medium text-gray-400 mb-1" }, "Referencia Armónica (Acordes/Voicings)"),
              React.createElement('input', { type: "text", id: "harmonicReference", value: harmonicReference, onChange: (e) => onParamChange('harmonicReference', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 text-sm", placeholder: "Ej: Bill Evans, coros de Queen, Ravel" })
          ),
          React.createElement('div', null,
              React.createElement('label', { htmlFor: "rhythmicReference", className: "block text-xs font-medium text-gray-400 mb-1" }, "Referencia Rítmica (Groove/Batería)"),
              React.createElement('input', { type: "text", id: "rhythmicReference", value: rhythmicReference, onChange: (e) => onParamChange('rhythmicReference', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 text-sm", placeholder: "Ej: J Dilla, el bajo de Thundercat, Daft Punk" })
          ),
          React.createElement('div', null,
              React.createElement('label', { htmlFor: "sonicReference", className: "block text-xs font-medium text-gray-400 mb-1" }, "Referencia Sonora (Instrumentación/Textura)"),
              React.createElement('input', { type: "text", id: "sonicReference", value: sonicReference, onChange: (e) => onParamChange('sonicReference', e.target.value), className: "w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 text-sm", placeholder: "Ej: Sintes de los 80, pianos lo-fi, Hans Zimmer" })
          )
       )
    ),
    React.createElement('div', { className: "w-full max-w-lg mt-8 flex justify-between" },
      React.createElement('button', { onClick: onBack, className: "px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors duration-200" }, "Atrás"),
      React.createElement('button', { onClick: onGenerate, className: "px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200" }, "Generar Progresión")
    )
  );
};

// --- From components/ResultDisplay.tsx ---
const ResultDisplay = ({ result, isLoading, error, bpm, chordDuration, musicKey, musicScale, onReset, onGenerateLine, generatedLines, isGeneratingLine, lockedChords, onToggleLock, onRegenerate, isRegenerating }) => {
  const [midiDataUri, setMidiDataUri] = useState(null);
  const [bassMidiUri, setBassMidiUri] = useState(null);
  const [melodyMidiUri, setMelodyMidiUri] = useState(null);
  const [ostinatoMidiUri, setOstinatoMidiUri] = useState(null);
  const [midiError, setMidiError] = useState(null);

  useEffect(() => {
    if (result) {
      setMidiError(null);
      try {
        const uri = generateFullMidiDataUri(result.progression, bpm, chordDuration, generatedLines);
        setMidiDataUri(uri);
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : 'Un error desconocido ocurrió al generar el MIDI.';
        console.error('Failed to generate MIDI file:', errorMessage);
        setMidiError(errorMessage);
        setMidiDataUri(null);
      }
    }
  }, [result, bpm, chordDuration, generatedLines]);
  
  useEffect(() => {
    if (generatedLines.bass) {
      try {
        const uri = generateSingleLineMidiDataUri(generatedLines.bass, bpm, 33);
        setBassMidiUri(uri);
      } catch (err) {
        console.error('Failed to generate BASS MIDI file:', err);
        setBassMidiUri(null);
      }
    } else {
        setBassMidiUri(null);
    }
  }, [generatedLines.bass, bpm]);

  useEffect(() => {
    if (generatedLines.melody) {
      try {
        const uri = generateSingleLineMidiDataUri(generatedLines.melody, bpm, 74);
        setMelodyMidiUri(uri);
      } catch (err) {
        console.error('Failed to generate MELODY MIDI file:', err);
        setMelodyMidiUri(null);
      }
    } else {
        setMelodyMidiUri(null);
    }
  }, [generatedLines.melody, bpm]);

  useEffect(() => {
    if (generatedLines.ostinato) {
      try {
        const uri = generateSingleLineMidiDataUri(generatedLines.ostinato, bpm, 82);
        setOstinatoMidiUri(uri);
      } catch (err) {
        console.error('Failed to generate OSTINATO MIDI file:', err);
        setOstinatoMidiUri(null);
      }
    } else {
        setOstinatoMidiUri(null);
    }
  }, [generatedLines.ostinato, bpm]);

  const handleDragStart = (e) => {
    if (midiDataUri) {
      e.dataTransfer.setData('DownloadURL', `audio/midi:progression_full.mid:${midiDataUri}`);
    }
  };

  const allLocked = lockedChords.every(Boolean);

  if (isLoading) return React.createElement(Loader);
  if (isRegenerating) return React.createElement(Loader, { isRegenerating: true });
  if (error) return React.createElement('div', { className: "text-center" },
    React.createElement('h2', { className: "text-2xl font-bold text-red-500 mb-4" }, "Error"),
    React.createElement('p', { className: "text-gray-300 mb-6" }, error),
    React.createElement('button', { onClick: onReset, className: "px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700" }, "Empezar de Nuevo")
  );
  if (!result) return null;
  
  return React.createElement('div', { className: "w-full max-w-5xl animate-fade-in" },
    React.createElement('h2', { className: "text-3xl font-bold text-white mb-6 text-center" }, "Tu Progresión Armónico-Emocional"),
    React.createElement('div', { className: "bg-gray-800/50 border border-gray-700 rounded-lg p-6 mb-6" },
      React.createElement('div', { className: "flex justify-between items-start mb-4 flex-wrap gap-4" },
        React.createElement('div', null,
          React.createElement('h3', { className: "text-xl font-semibold text-indigo-400" }, "Progresión de Acordes"),
          React.createElement('p', { className: "text-sm text-gray-400 mt-1" }, `${musicKey} ${musicScale}`)
        ),
        React.createElement('div', { className: "flex flex-col items-end" },
          midiError && React.createElement('div', { className: "text-sm text-red-400 text-right mb-2 p-2 bg-red-900/20 border border-red-500/30 rounded-md" }, 
            React.createElement('p', null, React.createElement('strong', null, "Error al generar MIDI:"), ` ${midiError}`)
          ),
           React.createElement('div', { className: "flex items-center gap-4" },
             React.createElement('button', { onClick: onRegenerate, disabled: allLocked || isGeneratingLine, className: "px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors flex items-center gap-2" },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { fillRule: "evenodd", d: "M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z", clipRule: "evenodd" })),
                "Regenerar Desbloqueados"
             ),
             midiDataUri && !midiError && React.createElement('div', { className: "flex items-center gap-4 pl-4 border-l border-gray-600" },
                React.createElement('a', { href: midiDataUri, download: "progression_full.mid", title: "Descargar MIDI Completo", className: "text-gray-400 hover:text-white transition-colors" },
                  React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" }))
                ),
                React.createElement('div', { draggable: true, onDragStart: handleDragStart, className: "cursor-grab active:cursor-grabbing", title: "Arrastrar al DAW" },
                  React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-8 w-8 text-indigo-400 hover:text-indigo-300", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { d: "M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8H1V6h18v2zM1 10h18v4H1v-4z" }))
                )
             )
           )
        )
      ),
      React.createElement('div', { className: "flex flex-wrap gap-4 justify-center" },
        result.progression.map((item, index) =>
          React.createElement('div', { key: `${item.chord}-${index}`, className: `relative bg-gray-900 p-4 rounded-lg text-center flex-grow flex flex-col justify-center min-w-[100px] shadow-md border border-gray-700 transition-all duration-300 ${lockedChords[index] ? 'border-indigo-500 ring-2 ring-indigo-500/50' : ''}` },
             React.createElement('button', { onClick: () => onToggleLock(index), title: lockedChords[index] ? 'Desbloquear Acorde' : 'Bloquear Acorde', className: "absolute top-2 right-2 text-gray-500 hover:text-white transition-colors" },
                lockedChords[index] ?
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 text-indigo-400", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { fillRule: "evenodd", d: "M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z", clipRule: "evenodd" })) :
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { d: "M10 3.5A3.5 3.5 0 006.5 7v2.5a.75.75 0 001.5 0V7A2 2 0 0110 5a2 2 0 012 2v1.5a.75.75 0 001.5 0V7A3.5 3.5 0 0010 3.5zM4 9.75A.75.75 0 014.75 9h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 9.75zM4.5 12a2.5 2.5 0 00-2.5 2.5v1A2.5 2.5 0 004.5 18h11a2.5 2.5 0 002.5-2.5v-1a2.5 2.5 0 00-2.5-2.5h-11z"}))
             ),
            React.createElement('p', { className: "text-2xl font-mono text-green-300 tracking-wider" }, item.chord),
            React.createElement('p', { className: "text-lg font-mono text-gray-400" }, item.degree),
            React.createElement('p', { className: "text-sm font-mono text-indigo-300 mt-1" }, item.notes)
          )
        )
      )
    ),
    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" },
      React.createElement('div', { className: "bg-gray-800/50 border border-gray-700 rounded-lg p-6 flex flex-col" },
        React.createElement('h3', { className: "text-xl font-semibold text-indigo-400 mb-3" }, "Línea de Bajo"),
        React.createElement('p', { className: "text-sm text-gray-400 flex-grow" }, generatedLines.bass ? "Línea de bajo generada y lista para descargar." : "Genera una línea de bajo para complementar tu progresión."),
        React.createElement('div', { className: "flex gap-2 mt-4" },
          React.createElement('button', { onClick: () => onGenerateLine('bass'), disabled: isGeneratingLine || isRegenerating, className: "px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-600 w-full transition-colors" },
            isGeneratingLine ? 'Generando...' : 'Generar Bajo'
          ),
          bassMidiUri && React.createElement('a', { href: bassMidiUri, download: "bass.mid", title: "Descargar solo Bajo (MIDI)", className: "flex-shrink-0 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors" }, "MIDI")
        )
      ),
      React.createElement('div', { className: "bg-gray-800/50 border border-gray-700 rounded-lg p-6 flex flex-col" },
        React.createElement('h3', { className: "text-xl font-semibold text-indigo-400 mb-3" }, "Melodía"),
        React.createElement('p', { className: "text-sm text-gray-400 flex-grow" }, generatedLines.melody ? "Melodía generada y lista para descargar." : "Genera una melodía que encaje con la armonía y emoción."),
        React.createElement('div', { className: "flex gap-2 mt-4" },
          React.createElement('button', { onClick: () => onGenerateLine('melody'), disabled: isGeneratingLine || isRegenerating, className: "px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-600 w-full transition-colors" },
            isGeneratingLine ? 'Generando...' : 'Generar Melodía'
          ),
          melodyMidiUri && React.createElement('a', { href: melodyMidiUri, download: "melody.mid", title: "Descargar solo Melodía (MIDI)", className: "flex-shrink-0 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors" }, "MIDI")
        )
      ),
      React.createElement('div', { className: "bg-gray-800/50 border border-gray-700 rounded-lg p-6 flex flex-col" },
        React.createElement('h3', { className: "text-xl font-semibold text-indigo-400 mb-3" }, "Ostinato"),
        React.createElement('p', { className: "text-sm text-gray-400 flex-grow" }, generatedLines.ostinato ? "Ostinato generado y listo para descargar." : "Genera un patrón rítmico/melódico repetitivo."),
        React.createElement('div', { className: "flex gap-2 mt-4" },
          React.createElement('button', { onClick: () => onGenerateLine('ostinato'), disabled: isGeneratingLine || isRegenerating, className: "px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-600 w-full transition-colors" },
            isGeneratingLine ? 'Generando...' : 'Generar Ostinato'
          ),
          ostinatoMidiUri && React.createElement('a', { href: ostinatoMidiUri, download: "ostinato.mid", title: "Descargar solo Ostinato (MIDI)", className: "flex-shrink-0 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors" }, "MIDI")
        )
      )
    ),
    React.createElement('div', { className: "bg-gray-800/50 border border-gray-700 rounded-lg p-6" },
      React.createElement('h3', { className: "text-xl font-semibold text-indigo-400 mb-3" }, "Análisis Armónico-Emocional"),
      React.createElement('div', { className: "text-gray-300 leading-relaxed whitespace-pre-wrap space-y-4" },
        result.analysis.split('\n').map((paragraph, index) => React.createElement('p', { key: index }, paragraph))
      )
    ),
    React.createElement('div', { className: "mt-8 text-center" },
      React.createElement('button', { onClick: onReset, className: "px-8 py-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 transform hover:scale-105" }, "Crear Otra Progresión")
    )
  );
};

// --- From App.tsx ---
const LoginScreen = ({onLoginSuccess}) => {
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const ACCESS_KEYS = ['abrinay', 'richardlove', 'alexking', 'avalon', 'kays', 'invitado'];
  const handleSubmit = (e) => {
    e.preventDefault();
    if (ACCESS_KEYS.includes(password.toLowerCase().trim())) {
      setError('');
      onLoginSuccess();
    } else {
      setError('Clave de acceso incorrecta.');
    }
  };
  return React.createElement('div', { className: "bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4" },
    React.createElement('div', { className: "text-center max-w-md w-full" },
      React.createElement('h1', { className: "text-4xl sm:text-5xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-500" }, "Maestro Emocional AI"),
      React.createElement('p', { className: "mt-4 text-lg text-gray-400" }, "Bienvenido. Por favor, introduce la clave de acceso para continuar."),
      React.createElement('form', { onSubmit: handleSubmit, className: "mt-8 space-y-6" },
        React.createElement('div', { className: "rounded-md shadow-sm" },
          React.createElement('div', null,
            React.createElement('label', { htmlFor: "password-input", className: "sr-only" }, "Clave de acceso"),
            React.createElement('input', { id: "password-input", name: "password", type: "password", value: password, onChange: (e) => setPassword(e.target.value), required: true, className: "appearance-none relative block w-full px-4 py-3 border border-gray-600 bg-gray-800 placeholder-gray-500 text-white rounded-lg focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm", placeholder: "Clave de acceso" })
          )
        ),
        error && React.createElement('p', { className: "text-red-400 text-sm text-center" }, error),
        React.createElement('div', null,
          React.createElement('button', { type: "submit", className: "group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition-colors" }, "Continuar")
        )
      ),
      React.createElement('footer', { className: "mt-12 text-xs text-gray-500" },
        React.createElement('p', null, "Powered by BUKOFLOW LLC")
      )
    )
  );
};
function App() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [selectedEmotions, setSelectedEmotions] = useState([]);
  const [musicKey, setMusicKey] = useState(MUSIC_KEYS[0]);
  const [musicScale, setMusicScale] = useState(MUSIC_SCALES[0]);
  const [bpm, setBpm] = useState(120);
  const [numChords, setNumChords] = useState(4);
  const [chordDuration, setChordDuration] = useState('1');
  const [voiceLeading, setVoiceLeading] = useState('smooth');
  const [styleModifiers, setStyleModifiers] = useState([]);
  const [emotionalContext, setEmotionalContext] = useState('');
  const [harmonicReference, setHarmonicReference] = useState('');
  const [rhythmicReference, setRhythmicReference] = useState('');
  const [sonicReference, setSonicReference] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isRegenerating, setIsRegenerating] = useState(false);
  const [isGeneratingLine, setIsGeneratingLine] = useState(false);
  const [result, setResult] = useState(null);
  const [generatedLines, setGeneratedLines] = useState({ bass: null, melody: null, ostinato: null });
  const [lockedChords, setLockedChords] = useState([]);
  const [error, setError] = useState(null);

  const handleLoginSuccess = () => setIsAuthenticated(true);
  
  const handleSelectEmotion = useCallback((emotionName) => {
    setSelectedEmotions(prev => {
      const isSelected = prev.some(e => e.name === emotionName);
      if (isSelected) {
        return prev.filter(e => e.name !== emotionName);
      } else if (prev.length < 4) {
        return [...prev, { id: Date.now() + Math.random(), name: emotionName }];
      }
      return prev;
    });
  }, []);

  const handleToggleModifier = useCallback((modifier) => {
    setStyleModifiers(prev => {
      const isSelected = prev.includes(modifier);
      if (isSelected) {
        return prev.filter(m => m !== modifier);
      } else if (prev.length < 3) {
        return [...prev, modifier];
      }
      return prev;
    });
  }, []);

  const handleParamChange = useCallback((param, value) => {
    const setters = {
      musicKey: setMusicKey,
      musicScale: setMusicScale,
      bpm: setBpm,
      numChords: setNumChords,
      chordDuration: setChordDuration,
      voiceLeading: setVoiceLeading,
      emotionalContext: setEmotionalContext,
      harmonicReference: setHarmonicReference,
      rhythmicReference: setRhythmicReference,
      sonicReference: setSonicReference,
    };
    const setter = setters[param];
    if (setter) setter(value);
  }, []);
  
  const handleNext = () => setCurrentStep(prev => Math.min(prev + 1, STEPS.length - 1));
  const handleBack = () => setCurrentStep(prev => Math.max(prev - 1, 0));

  const handleReset = () => {
    setCurrentStep(0);
    setSelectedEmotions([]);
    setMusicKey(MUSIC_KEYS[0]);
    setMusicScale(MUSIC_SCALES[0]);
    setBpm(120);
    setNumChords(4);
    setChordDuration('1');
    setVoiceLeading('smooth');
    setStyleModifiers([]);
    setEmotionalContext('');
    setHarmonicReference('');
    setRhythmicReference('');
    setSonicReference('');
    setIsLoading(false);
    setIsRegenerating(false);
    setIsGeneratingLine(false);
    setResult(null);
    setGeneratedLines({ bass: null, melody: null, ostinato: null });
    setLockedChords([]);
    setError(null);
  };
  
  const handleGenerate = async () => {
    setCurrentStep(2);
    setIsLoading(true);
    setError(null);
    setResult(null);
    setGeneratedLines({ bass: null, melody: null, ostinato: null });
    const emotionNames = selectedEmotions.map(e => e.name);
    const keyAndScale = `${musicKey} ${musicScale}`;
    try {
      const generatedResult = await generateChordProgression(emotionNames, keyAndScale, bpm, numChords, styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference, voiceLeading);
      setResult(generatedResult);
      setLockedChords(new Array(generatedResult.progression.length).fill(false));
    } catch (e) {
      setError(e.message || "An unknown error occurred.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleRegenerate = async () => {
      setIsRegenerating(true);
      setError(null);
      const lockedIndices = lockedChords.map((isLocked, index) => isLocked ? index : -1).filter(index => index !== -1);
      const emotionNames = selectedEmotions.map(e => e.name);
      const keyAndScale = `${musicKey} ${musicScale}`;
      try {
          const regenerationResult = await generateChordProgression(
              emotionNames, keyAndScale, bpm, result.progression.length, styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference, voiceLeading,
              {
                  currentProgression: result.progression,
                  lockedIndices,
                  originalAnalysis: result.analysis
              }
          );
          setResult(regenerationResult);
      } catch (e) {
          setError(e.message || "No se pudo regenerar la progresión.");
      } finally {
          setIsRegenerating(false);
      }
  };

  const handleToggleLock = (index) => {
    const newLocked = [...lockedChords];
    newLocked[index] = !newLocked[index];
    setLockedChords(newLocked);
  };
  
  const handleGenerateLine = async (lineType) => {
      if (!result) return;
      setIsGeneratingLine(true);
      setError(null);
      try {
        const line = await generateMusicalLine(
            result.progression,
            selectedEmotions.map(e => e.name),
            `${musicKey} ${musicScale}`,
            bpm,
            lineType,
            styleModifiers,
            emotionalContext,
            harmonicReference,
            rhythmicReference,
            sonicReference
        );
        setGeneratedLines(prev => ({ ...prev, [lineType]: line }));
      } catch (e) {
        setError(e.message || `Failed to generate ${lineType} line.`);
      } finally {
        setIsGeneratingLine(false);
      }
  };

  const renderCurrentStep = () => {
    switch (currentStep) {
      case 0:
        return React.createElement(EmotionSelector, { selectedEmotions, onToggleEmotion: handleSelectEmotion, onReorderEmotions: setSelectedEmotions, onNext: handleNext });
      case 1:
        return React.createElement(ParametersForm, { musicKey, musicScale, bpm, numChords, chordDuration, voiceLeading, styleModifiers, emotionalContext, harmonicReference, rhythmicReference, sonicReference, onToggleModifier: handleToggleModifier, onParamChange: handleParamChange, onBack: handleBack, onGenerate: handleGenerate });
      case 2:
        return React.createElement(ResultDisplay, { result, isLoading, error, bpm, chordDuration, onReset: handleReset, musicKey, musicScale, onGenerateLine: handleGenerateLine, generatedLines, isGeneratingLine, lockedChords, onToggleLock: handleToggleLock, onRegenerate: handleRegenerate, isRegenerating });
      default:
        return null;
    }
  };

  if (!isAuthenticated) {
    return React.createElement(LoginScreen, { onLoginSuccess: handleLoginSuccess });
  }

  return React.createElement('div', { className: "bg-gray-900 text-white min-h-screen flex flex-col items-center p-4 sm:p-8" },
    React.createElement('header', { className: "text-center mb-8" },
      React.createElement('h1', { className: "text-4xl sm:text-5xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-500" }, "Maestro Emocional AI"),
      currentStep < 2 && React.createElement('p', { className: "mt-4 text-lg text-gray-400 max-w-2xl mx-auto" }, "Crea música a partir de tus sentimientos.")
    ),
    React.createElement('div', { className: "w-full max-w-4xl mb-12" },
      React.createElement(Stepper, { steps: STEPS, currentStep: currentStep })
    ),
    React.createElement('main', { className: "w-full max-w-5xl flex-grow flex items-center justify-center p-4 sm:p-8 bg-gray-800 rounded-xl shadow-2xl border border-gray-700" },
      renderCurrentStep()
    ),
    React.createElement('footer', { className: "mt-8 text-xs text-gray-500" },
      React.createElement('p', null, "Powered by BUKOFLOW LLC")
    )
  );
}

// --- Render Call ---
const rootElement = document.getElementById('root');
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(React.StrictMode, null, React.createElement(App)));

    </script>
</body>
</html>
